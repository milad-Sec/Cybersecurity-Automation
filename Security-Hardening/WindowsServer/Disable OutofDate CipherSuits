<#
.SYNOPSIS
  Hardening Script for IIS - Disable Outdated Cipher Suites
  Based on CIS Benchmarks for Windows Server / IIS

.DESCRIPTION
  This script disables weak SSL/TLS protocols and ciphers by updating
  the Windows Registry for Schannel. It requires Administrator privileges
  and a server reboot to take effect.

.NOTES
  Author: Milad
  Reference: CIS Benchmark, Microsoft Schannel Registry settings
#>

Write-Host "=== IIS / Windows Server SSL & Cipher Hardening ===" -ForegroundColor Cyan

# Function to disable protocol
function Disable-Protocol {
    param([string]$Protocol)

    $basePath = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\$Protocol"
    if (-not (Test-Path $basePath)) { New-Item -Path $basePath -Force | Out-Null }
    if (-not (Test-Path "$basePath\Server")) { New-Item -Path "$basePath\Server" -Force | Out-Null }
    New-ItemProperty -Path "$basePath\Server" -Name "Enabled" -Value 0 -PropertyType "DWord" -Force | Out-Null
    New-ItemProperty -Path "$basePath\Server" -Name "DisabledByDefault" -Value 1 -PropertyType "DWord" -Force | Out-Null

    Write-Host "Disabled $Protocol" -ForegroundColor Yellow
}

# Function to enable protocol
function Enable-Protocol {
    param([string]$Protocol)

    $basePath = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\$Protocol"
    if (-not (Test-Path $basePath)) { New-Item -Path $basePath -Force | Out-Null }
    if (-not (Test-Path "$basePath\Server")) { New-Item -Path "$basePath\Server" -Force | Out-Null }
    New-ItemProperty -Path "$basePath\Server" -Name "Enabled" -Value 1 -PropertyType "DWord" -Force | Out-Null
    New-ItemProperty -Path "$basePath\Server" -Name "DisabledByDefault" -Value 0 -PropertyType "DWord" -Force | Out-Null

    Write-Host "Enabled $Protocol" -ForegroundColor Green
}

# Disable weak protocols
Disable-Protocol "SSL 2.0"
Disable-Protocol "SSL 3.0"
Disable-Protocol "TLS 1.0"
Disable-Protocol "TLS 1.1"

# Enable strong protocols
Enable-Protocol "TLS 1.2"
Enable-Protocol "TLS 1.3"

# Disable weak cipher suites
$ciphers = @(
    "NULL", "DES", "RC2 40/128", "RC2 56/128", "RC4 40/128", "RC4 56/128", 
    "RC4 64/128", "RC4 128/128", "Triple DES 168"
)

foreach ($cipher in $ciphers) {
    $path = "HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\$cipher"
    if (-not (Test-Path $path)) { New-Item -Path $path -Force | Out-Null }
    New-ItemProperty -Path $path -Name "Enabled" -Value 0 -PropertyType "DWord" -Force | Out-Null
    Write-Host "Disabled $cipher" -ForegroundColor Yellow
}

Write-Host "`nHardening complete. Please REBOOT the server for changes to take effect." -ForegroundColor Cyan
